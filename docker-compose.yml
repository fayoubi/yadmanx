version: '3.8'

services:
  # Pricing Service
  pricing-service:
    build: ./pricing-service
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DATABASE_URL=postgresql://postgres:postgres@pricing-db:5432/pricing
      - REDIS_URL=redis://pricing-redis:6379
      - ENABLE_TERM_LIFE=true
    depends_on:
      - pricing-db
      - pricing-redis
    volumes:
      - ./pricing-service:/app
      - /app/node_modules
    restart: unless-stopped

  pricing-db:
    image: postgres:15
    environment:
      - POSTGRES_DB=pricing
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - pricing-db-data:/var/lib/postgresql/data
      - ./pricing-service/src/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    restart: unless-stopped

  pricing-redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - pricing-redis-data:/data
    restart: unless-stopped

  # Enrollment Service
  enrollment-service:
    build: ./enrollment-service
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - DATABASE_URL=postgresql://postgres:postgres@enrollment-db:5432/enrollment
      - ENCRYPTION_KEY=dev-key-change-in-production
    depends_on:
      - enrollment-db
    volumes:
      - ./enrollment-service:/app
      - /app/node_modules
    restart: unless-stopped

  enrollment-db:
    image: postgres:15
    environment:
      - POSTGRES_DB=enrollment
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5433:5432"
    volumes:
      - enrollment-db-data:/var/lib/postgresql/data
      - ./enrollment-service/db/migrations:/docker-entrypoint-initdb.d
    restart: unless-stopped

  # Agent Service
  agent-service:
    build: ./agent-service
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - DATABASE_URL=postgresql://postgres:postgres@agent-db:5432/agent
      - JWT_SECRET=dev-jwt-secret-change-in-production
      - JWT_EXPIRES_IN=24h
      - OTP_EXPIRES_IN=5
      - MAX_OTP_ATTEMPTS=5
      - LOCKOUT_DURATION=30
      - ENROLLMENT_SERVICE_URL=http://enrollment-service:3002
    depends_on:
      - agent-db
      - enrollment-service
    volumes:
      - ./agent-service:/app
      - /app/node_modules
    restart: unless-stopped

  agent-db:
    container_name: yadmanx-agent-db
    image: postgres:15
    environment:
      - POSTGRES_DB=agent
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5434:5432"
    volumes:
      - agent-db-data-new:/var/lib/postgresql/data
      - ./agent-service/db/migrations:/docker-entrypoint-initdb.d
    restart: unless-stopped

  # LLM Quote Service
  llm-quote-service:
    build: ./llm-quote-service
    ports:
      - "3004:3004"
    env_file:
      - ./llm-quote-service/.env
    environment:
      - NODE_ENV=development
      - PORT=3004
      - PRICING_SERVICE_URL=http://pricing-service:3001
      - REDIS_HOST=llm-quote-redis
      - REDIS_PORT=6379
      - SESSION_TTL=1800
    depends_on:
      - llm-quote-redis
      - pricing-service
    volumes:
      - ./llm-quote-service:/app
      - /app/node_modules
    restart: unless-stopped

  llm-quote-redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - llm-quote-redis-data:/data
    restart: unless-stopped

  # pgAdmin
  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@yadmanx.com
      - PGADMIN_DEFAULT_PASSWORD=admin
      - PGADMIN_CONFIG_SERVER_MODE=False
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    restart: unless-stopped

volumes:
  pricing-db-data:
  pricing-redis-data:
  enrollment-db-data:
  agent-db-data-new:
  llm-quote-redis-data:
  pgadmin-data: