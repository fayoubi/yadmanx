====================================================================
YadmanX - JWT Token Generation for Enrollment API Testing
====================================================================

This file explains how to generate a JWT token for testing the
Enrollment Service API in Postman.

====================================================================
OVERVIEW
====================================================================

The enrollment service requires JWT authentication. Tokens are
generated by the Agent Service after successful OTP verification.

Token Details:
- Expiration: 24 hours
- Issuer: 'yadmanx-agent-service'
- Secret: Environment variable JWT_SECRET (default: 'change-this-in-production')
- Algorithm: HS256

====================================================================
OPTION 1: GENERATE TOKEN VIA AGENT SERVICE (RECOMMENDED)
====================================================================

Step 1: Ensure Agent Service is Running
----------------------------------------
Terminal:
  cd agent-service
  npm start

Verify: http://localhost:3003/health should return 200 OK


Step 2: Get Agent Phone Number from Database
---------------------------------------------
You need a valid agent's phone number to request OTP.

PostgreSQL query:
  SELECT id, phone_number, email, first_name, last_name, status
  FROM agents
  WHERE status = 'active'
  LIMIT 1;

Example result:
  id: a7c65d2e-3e72-4702-b5ba-3a8f593847ea
  phone_number: +212612345678
  email: agent@example.com
  status: active


Step 3: Request OTP Code
-------------------------
Use curl, Postman, or any HTTP client:

  curl -X POST http://localhost:3003/api/v1/auth/send-otp \
    -H "Content-Type: application/json" \
    -d '{
      "phone_number": "+212612345678"
    }'

Response:
  {
    "success": true,
    "message": "OTP sent successfully"
  }

Note: The OTP code is sent to the phone number or logged to console
(depending on your SMS provider setup).


Step 4: Find the OTP Code
--------------------------
OPTION A - Check Database:

  SELECT code, phone_number, expires_at, created_at
  FROM otp_codes
  WHERE phone_number = '+212612345678'
    AND expires_at > NOW()
  ORDER BY created_at DESC
  LIMIT 1;

  Example result:
    code: 123456
    expires_at: 2026-01-02 12:15:00

OPTION B - Check Agent Service Logs:

  Look for log output like:
    "OTP Code: 123456 (expires in 5 minutes)"


Step 5: Verify OTP and Get JWT Token
-------------------------------------
Use the OTP code from Step 4:

  curl -X POST http://localhost:3003/api/v1/auth/verify-otp \
    -H "Content-Type: application/json" \
    -d '{
      "phone_number": "+212612345678",
      "code": "123456"
    }'

Response:
  {
    "success": true,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZ2VudElkIjoiYTdjNjVkMmUtM2U3Mi00NzAyLWI1YmEtM2E4ZjU5Mzg0N2VhIiwicGhvbmVOdW1iZXIiOiIrMjEyNjEyMzQ1Njc4IiwiZW1haWwiOiJhZ2VudEBleGFtcGxlLmNvbSIsImxpY2Vuc2VOdW1iZXIiOiJMSUMxMjM0NTYiLCJmaXJzdE5hbWUiOiJKb2huIiwibGFzdE5hbWUiOiJBZ2VudCIsImFnZW5jeU5hbWUiOiJUZXN0IEFnZW5jeSIsImlhdCI6MTcwNDIwMDAwMCwiZXhwIjoxNzA0Mjg2NDAwLCJpc3MiOiJ5YWRtYW54LWFnZW50LXNlcnZpY2UifQ.dGhpc19pc19hX3NhbXBsZV9zaWduYXR1cmU",
    "expiresIn": "24h",
    "agent": {
      "id": "a7c65d2e-3e72-4702-b5ba-3a8f593847ea",
      "phone_number": "+212612345678",
      "email": "agent@example.com",
      "first_name": "John",
      "last_name": "Agent",
      "license_number": "LIC123456",
      "status": "active"
    }
  }


Step 6: Copy Token to Postman
------------------------------
1. Copy the "token" value (the long eyJ... string)
2. Open Postman
3. Click environment quick look (eye icon in top right)
4. Click "Edit" next to "YadmanX - Enrollment Service (Local)"
5. Find the "jwt_token" variable
6. Paste your token into the "Current Value" field
7. Ensure type is set to "secret" (to hide the token)
8. Click "Save"

Your token is now ready for use!


====================================================================
OPTION 2: GENERATE TOKEN MANUALLY (FOR DEVELOPMENT)
====================================================================

If you have direct access to the JWT_SECRET, you can generate a
token manually using jwt.io or a Node.js script.

Node.js Script (create test-token.js):
---------------------------------------
const jwt = require('jsonwebtoken');

const payload = {
  agentId: 'a7c65d2e-3e72-4702-b5ba-3a8f593847ea',
  phoneNumber: '+212612345678',
  email: 'agent@example.com',
  licenseNumber: 'LIC123456',
  firstName: 'John',
  lastName: 'Agent',
  agencyName: 'Test Agency'
};

const secret = process.env.JWT_SECRET || 'change-this-in-production';

const token = jwt.sign(payload, secret, {
  expiresIn: '24h',
  issuer: 'yadmanx-agent-service'
});

console.log('JWT Token:');
console.log(token);

Run the script:
  node test-token.js

Copy the output token to Postman environment.


====================================================================
OPTION 3: USE DEVELOPMENT FALLBACK (IF ENABLED)
====================================================================

Some development environments may accept the x-agent-id header as
a fallback authentication method.

Check if enabled in:
  enrollment-service/src/middleware/auth.middleware.js

If the fallback is enabled:
1. In Postman, edit any request
2. Go to "Headers" tab
3. Add header:
   Key: x-agent-id
   Value: a7c65d2e-3e72-4702-b5ba-3a8f593847ea
4. Remove jwt_token from environment OR disable auth

WARNING: This is ONLY for local development and should NOT be
enabled in production environments.


====================================================================
TROUBLESHOOTING
====================================================================

Problem: "OTP expired"
Solution: OTP codes expire after 5 minutes. Request a new OTP.

Problem: "Invalid OTP code"
Solution:
  - Check you're using the most recent code
  - Verify phone number matches exactly
  - Ensure code hasn't been used already (one-time use)
  - Check database for the actual code

Problem: "Agent not found"
Solution:
  - Verify agent exists in database
  - Check agent status is 'active'
  - Ensure phone number format includes country code (+212...)

Problem: "Invalid token" when making API requests
Solution:
  - Token may have expired (24-hour lifetime)
  - Verify token is correctly copied (no spaces/truncation)
  - Check JWT_SECRET matches between agent-service and enrollment-service
  - Generate a fresh token

Problem: "No authorization token provided"
Solution:
  - Verify jwt_token is set in Postman environment
  - Check environment is selected (top-right dropdown)
  - Ensure collection pre-request script is adding Authorization header


====================================================================
TOKEN PAYLOAD STRUCTURE
====================================================================

A decoded JWT token contains:

Header:
  {
    "alg": "HS256",
    "typ": "JWT"
  }

Payload:
  {
    "agentId": "a7c65d2e-3e72-4702-b5ba-3a8f593847ea",
    "phoneNumber": "+212612345678",
    "email": "agent@example.com",
    "licenseNumber": "LIC123456",
    "firstName": "John",
    "lastName": "Agent",
    "agencyName": "Test Agency",
    "iat": 1704200000,        // Issued at (Unix timestamp)
    "exp": 1704286400,        // Expires at (Unix timestamp)
    "iss": "yadmanx-agent-service"
  }

Signature: (secret-based hash)

You can decode your token at https://jwt.io to verify its contents.


====================================================================
SECURITY NOTES
====================================================================

1. JWT tokens are sensitive credentials - treat them like passwords
2. Tokens expire after 24 hours for security
3. Never commit tokens to version control
4. Use Postman's "secret" variable type to hide tokens
5. In production, ensure JWT_SECRET is a strong, random value
6. Tokens are agent-specific - each agent needs their own token
7. OTP codes are single-use and expire after 5 minutes


====================================================================
QUICK REFERENCE
====================================================================

Default Values (Postman Environment):
  base_url: http://localhost:3002
  api_version: v1
  agent_id: a7c65d2e-3e72-4702-b5ba-3a8f593847ea
  jwt_token: (you must set this)

Agent Service Endpoints:
  POST /api/v1/auth/send-otp
  POST /api/v1/auth/verify-otp

Enrollment Service Endpoints:
  POST   /api/v1/enrollments
  GET    /api/v1/enrollments
  GET    /api/v1/enrollments/:id
  GET    /api/v1/enrollments/:id/steps/:stepName
  PUT    /api/v1/enrollments/:id
  DELETE /api/v1/enrollments/:id

Database Tables:
  - agents (agent service)
  - otp_codes (agent service)
  - enrollments (enrollment service)
  - customers (enrollment service)

For more details, see README.md
